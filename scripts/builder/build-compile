#!/usr/bin/env build

echo "compiling: ${1}"

if [ -z "${CHOST}" ]; then
	CROSS_COMPILE="${CHOST}-"
	export CROSS_COMPILE CHOST
fi

if [ -z "${ARCH}" ]; then
	export ARCH
fi

# Don't pass along the builder jobcontrol data to child processes
unset MAKEFLAGS

PATH="${BUILDER_SYSROOT}/usr/bin:${PATH}"
export PATH

pkg_compile()
{
	# FIXME these defaults need moved elsewhere
	if [ -f "configure" ]; then
		./configure	--host="${CHOST}"			\
				--prefix="/usr" --mandir=/usr/share/man	\
				--docdir=/usr/share/doc			\
				--sysconfdir=/etc			\
				${CONFIG_OPTS}
	fi

	# FIXME we need a bunch of make options in here
	make ${MAKE_OPTS} && make DESTDIR="${D}" install
}

import "${1}"

# define the toolchain
if [ -z "${TOOLCHAIN}" ]; then
	CC="${CROSS_COMPILE}gcc"
	CXX="${CROSS_COMPILE}g++"
	LD="${CROSS_COMPILE}ld"
	AR="${CROSS_COMPILE}ar"
	STRIP="${CROSS_COMPILE}strip"
	RANDLIB="${CROSS_COMPILE}ranlib"
	export CC CXX LD AR STRIP RANLIB
fi

# pkgconfig can be a right pita...
PKG_CONFIG_LIBDIR="${BUILDER_SYSROOT}/usr/share/pkgconfig:${BUILDER_SYSROOT}/usr/lib/pkgconfig"
export PKG_CONFIG_LIBDIR PKG_CONFIG_PATH
export PKG_CONFIG_SYSROOT_DIR="${BUILDER_SYSROOT}"

[ -d "${D}" ] || mkdir -p "${D}"
[ -d "${S}" ] || mkdir -p "${S}"
[ -d "${L}" ] || mkdir -p "${L}"
if [ -f "${L}/compile.log" ]; then
	rm "${L}/compile.log" || exit 1
fi
echo "== ENV ==" > "${L}/compile.log"
env >> "${L}/compile.log"
echo "=========" >> "${L}/compile.log"

cd "${S}"
pkg_compile >> "${L}/compile.log" 2>&1
date --utc > "${L}/.compiled"

# vim: filetype=sh
